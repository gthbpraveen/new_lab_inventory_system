{% extends "login_home.html" %}
{% block title %}Equipment List{% endblock %}

{% block content %}
<section class="py-10">
  <div class="max-w-7xl mx-auto px-6">
    <div class="bg-white shadow rounded-lg p-6 border border-gray-300">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold text-indigo-700">Equipment List</h2>
        {% if current_user.role != "student" %}
        <a href="{{ url_for('equipment_entry') }}" 
           class="bg-green-600 text-white px-4 py-2 rounded-md shadow hover:bg-green-700">
          + Add Asset
        </a>
        {% endif %}
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left border border-gray-300 min-w-[800px]">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="p-3 border">S.No</th>
              <th class="p-3 border">Department Code</th>
              <th class="p-3 border">Category</th>
              <th class="p-3 border">Status</th>
              {% if current_user.role != "student" %}
              <th class="p-3 border">Assigned To</th>
              <th class="p-3 border">Assign / Change</th>
              <th class="p-3 border">Edit / Delete</th>
              <th class="p-3 border">History</th>
              {% endif %}
            </tr>
          </thead>

          <tbody>
            {% if grouped_equipment %}
              {% for category, items in grouped_equipment.items() %}
              <tr class="bg-indigo-100">
                <td colspan="8" class="p-3 font-semibold text-indigo-700 uppercase">
                  {{ category }}
                </td>
              </tr>
              {% for eq in items %}
              <tr class="border-b hover:bg-gray-50">
                <td class="p-3">{{ loop.index }}</td>
                <td class="p-3">
                  <a href="#" class="text-indigo-600 hover:underline" 
                     onclick="document.getElementById('details-{{ eq.id }}').classList.toggle('hidden'); return false;">
                    {{ eq.department_code }}
                  </a>
                </td>
                <td class="p-3">{{ eq.category }}</td>
                <td class="p-3">{{ eq.status }}</td>

                {% if current_user.role != "student" %}
                <!-- Assigned To display -->
                <td class="p-3">
                  {% if eq.student %}
                    {{ eq.student.name }} ({{ eq.student.roll }})
                  {% else %}
                    <span class="text-gray-500">Unassigned</span>
                  {% endif %}
                </td>

                <!-- Assign / Change logic (preserved exactly) -->
                <td class="p-3">
                  {% if eq.status.lower() in ['available', 'issued'] %}
                    {% if eq.assigned_to_roll %}
                      <a href="{{ url_for('it_equipment_assign', roll=eq.assigned_to_roll) }}" 
                         class="text-indigo-600 hover:underline text-sm">Assign / Change</a>
                    {% else %}
                      <a href="{{ url_for('allotted_roll_check', roll=eq.assigned_to_roll, equipment_id=eq.id) }}" 
                         class="text-indigo-600 hover:underline text-sm">Assign</a>
                    {% endif %}
                  {% elif eq.status.lower() == 'retired' %}
                    <span class="text-gray-500 text-sm">Retired</span>
                  {% elif eq.status.lower() == 'scrapped' %}
                    <span class="text-gray-500 text-sm">Scrapped</span>
                  {% else %}
                    <span class="text-gray-500 text-sm">{{ eq.status }}</span>
                  {% endif %}
                </td>

                <!-- Edit / Delete -->
                <td class="p-3">
                  <a href="{{ url_for('edit_equipment', id=eq.id) }}" class="text-blue-600 hover:underline">Edit</a> /
                  <form method="POST" action="{{ url_for('delete_equipment', id=eq.id) }}" class="inline"
                        onsubmit="return confirm('Are you sure?');">
                    <button type="submit" class="text-red-600 hover:underline bg-transparent border-none">Delete</button>
                  </form>
                </td>

                <!-- History -->
                <td class="p-3">
                  <a href="{{ url_for('equipment_history', equipment_id=eq.id) }}" class="text-green-600 hover:underline">View</a>
                </td>
                {% endif %}
              </tr>

              <!-- Expanded details row -->
              <tr id="details-{{ eq.id }}" class="hidden bg-gray-50">
                <td colspan="8" class="p-4">
                  <table class="w-full text-sm border border-gray-300">
                    <tr><th class="p-2 border bg-gray-100">Name</th><td class="p-2 border">{{ eq.name }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Manufacturer</th><td class="p-2 border">{{ eq.manufacturer }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Model</th><td class="p-2 border">{{ eq.model }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Serial No</th><td class="p-2 border">{{ eq.serial_number }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">MAC Address</th><td class="p-2 border">{{ eq.mac_address }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Invoice No</th><td class="p-2 border">{{ eq.invoice_number }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Cost/Unit</th><td class="p-2 border">{{ eq.cost_per_unit }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Warranty Start</th><td class="p-2 border">{{ eq.warranty_start }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Warranty Expiry</th><td class="p-2 border">{{ eq.warranty_expiry }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Location</th><td class="p-2 border">{{ eq.location }}</td></tr>
                    <!-- <tr><th class="p-2 border bg-gray-100">Purchase Date</th><td class="p-2 border">{{ eq.purchase_date }}</td></tr> -->
                    <tr><th class="p-2 border bg-gray-100">PO Date</th><td class="p-2 border">{{ eq.po_date }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">PO Number</th><td class="p-2 border">{{ eq.po_number }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Indenter</th><td class="p-2 border">{{ eq.intender_name }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Quantity</th><td class="p-2 border">{{ eq.quantity }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Vendor Company</th><td class="p-2 border">{{ eq.vendor_company }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Vendor Contact</th><td class="p-2 border">{{ eq.vendor_contact_person }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Vendor Mobile</th><td class="p-2 border">{{ eq.vendor_mobile }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Assigned To</th><td class="p-2 border">{{ eq.student.name if eq.student else 'Unassigned' }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Assigned By</th><td class="p-2 border">{{ eq.assigned_by }}</td></tr>
                    <tr><th class="p-2 border bg-gray-100">Assigned Date</th><td class="p-2 border">{{ eq.assigned_date }}</td></tr>
                  </table>
                </td>
              </tr>

              {% endfor %}
              {% endfor %}
            {% else %}
            <tr>
              <td colspan="8" class="p-3 text-center text-gray-500">No equipment found.</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
{% endblock %}
