{% extends "login_home.html" %}
{% block title %}Lab Cubicle Allocation{% endblock %}

{% block content %}
<div class="max-w-8xl mx-auto px-4 py-4">
  <header class="bg-pink-100 rounded-md shadow-sm p-4 text-center">
    <div class="flex flex-col items-center justify-center space-y-2">
      <h1 class="text-xl sm:text-2xl font-semibold text-blue-700" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);">
        Lab Cubicle Space Allocation
      </h1>
      <p class="text-indigo-700 text-sm sm:text-base">
        Please fill out the following details carefully
      </p>
    </div>
  </header>
</div>

{% if error %}
  <div id="errorAlert" class="relative bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    <strong>Warning:</strong> {{ error }}
    <button type="button" onclick="document.getElementById('errorAlert').style.display='none'"
            class="absolute top-0 right-0 mt-1 mr-2 text-2xl leading-none text-red-700 hover:text-red-900 focus:outline-none">
      &times;
    </button>
  </div>
{% endif %}

{% if success %}
  <div class="bg-green-100 border border-green-400 text-green-800 px-4 py-3 rounded mb-4">
    âœ… Cubicle space has been successfully allotted.
  </div>
{% endif %}

<form id="allocation-form" method="POST" action="{{ url_for('cubicle_allocation') }}" class="bg-white rounded-b-lg shadow-lg p-6 mb-8">
  <div class="form-section bg-blue-50 rounded-lg p-6 mb-8">
    <h2 class="text-xl font-semibold text-indigo-800 mb-4 border-b border-indigo-200 pb-2">Student Details</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="name" class="block text-gray-700 font-medium mb-2">Full Name</label>
        <input type="text" id="name" name="name" required value="{{ form_data.name if form_data else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-md">
      </div>
      <div>
        <label for="roll" class="block text-gray-700 font-medium mb-2">Roll Number</label>
        <input type="text" id="roll" name="roll" required value="{{ form_data.roll if form_data else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-md">
      </div>
      <div>
        <label for="course" class="block text-gray-700 font-medium mb-2">Course</label>
        <select id="course" name="course" required class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="">Select Course</option>
          {% for c in ["B.Tech", "M.Tech TA", "M.Tech RA", "Ph.D.", "Intern"] %}
          <option value="{{ c }}" {% if form_data and form_data.course == c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="year" class="block text-gray-700 font-medium mb-2">Year of Study</label>
        <select id="year" name="year" required class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="">Select Year</option>
          {% for y in ["I", "II", "III", "IV", "V"] %}
          <option value="{{ y }}" {% if form_data and form_data.year == y %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="faculty" class="block text-gray-700 font-medium mb-2">Faculty In-charge</label>
        <select id="faculty" name="faculty" required class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="">Select Faculty</option>
          {% for fac in ["Prof. Antony Franklin", "Dr. Ashish Mishra", "Prof. Bheemarjuna Reddy Tamma", "Prof. C. Krishna Mohan", "Dr. J. Saketha Nath", "Dr. Jyothi Vedurada", "Dr. Kotaro Kataoka", "Prof. M. V. Panduranga Rao", "Dr. Manish Singh", "Dr. Maria Francis", "Prof. Maunendra Sankar Desarkar", "Dr. N. R. Aravind", "Dr. Nitin Saurabh", "Dr. Praveen Tammana", "Dr. Rajesh Kedia", "Dr. Rakesh Venkat", "Dr. Ramakrishna Upadrasta", "Dr. Rameshwar Pratap", "Dr. Rogers Mathew", "Prof. Sathya Peri", "Dr. Saurabh Kumar", "Dr. Shirshendu Das", "Dr. Sobhan Babu", "Dr. Srijith P. K.", "Prof. Subrahmanyam Kalyanasundaram", "Prof. Vineeth N. Balasubramanian", "Prof. C. Siva Ram Murthy", "Prof. Ponnurangam Kumaraguru", "Dr. Kenzo Fujisue", "Dr. Naveen Sivadasan"] %}
          <option value="{{ fac }}" {% if form_data and form_data.faculty == fac %}selected{% endif %}>{{ fac }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="staff_incharge" class="block text-gray-700 font-medium mb-2">Staff In-charge</label>
        <select id="staff_incharge" name="staff_incharge" class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="">Select Staff</option>
          {% for staff in ["N. Syamala Rao", "T. Vijayachakravarthi", "Nikith Reddy Peddasheri", "Sunitha Maloth", "G Praveen Kumar", "Shiva Kumar Reddy", "Kiran Kumar Kavali"] %}
          <option value="{{ staff }}" {% if form_data and form_data.staff_incharge == staff %}selected{% endif %}>{{ staff }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="email" class="block text-gray-700 font-medium mb-2">Email</label>
        <input type="email" id="email" name="email" required value="{{ form_data.email if form_data else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-md">
      </div>
      <div>
        <label for="phone" class="block text-gray-700 font-medium mb-2">Phone</label>
        <input type="tel" id="phone" name="phone" value="{{ form_data.phone if form_data else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-md">
      </div>

      <!-- Room & Cubicle (DB-driven) -->
      <div>
        <label for="room_lab_name" class="block text-gray-700 font-medium mb-2">Room/Lab Name</label>
        <select id="room_lab_name" name="room_lab_name" required class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="">Select Room</option>
          {% for r in rooms %}
            <option value="{{ r.name }}" {% if form_data and form_data.room_lab_name == r.name %}selected{% endif %}>{{ r.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="cubicle_no" class="block text-gray-700 font-medium mb-2">Cubicle Number</label>
        <select id="cubicle_no" name="cubicle_no" required class="w-full px-4 py-2 border border-gray-300 rounded-md">
          <option value="">-- Select Cubicle --</option>
        </select>
        <p class="text-xs text-gray-500 mt-1" id="cubHint">Choose a room to see available cubicles.</p>
      </div>
    </div>
  </div>

  <div class="flex justify-end">
    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
      Submit
    </button>
  </div>
</form>

<script>
  // room_map: { "CS-107": [ {id, number}, ...free... ], ... }
  const roomMap = {{ room_map | tojson }};
  const roomSelect = document.getElementById("room_lab_name");
  const cubicleSelect = document.getElementById("cubicle_no");
  const cubHint = document.getElementById("cubHint");

  function populateCubicles() {
    const room = roomSelect.value;
    cubicleSelect.innerHTML = '<option value="">-- Select Cubicle --</option>';
    if (!room || !roomMap[room]) {
      cubHint.textContent = room ? "No free cubicles in this room." : "Choose a room to see available cubicles.";
      return;
    }
    const list = roomMap[room];
    for (const c of list) {
      const opt = document.createElement("option");
      opt.value = c.number;     // we post by number; route queries by room+number
      opt.textContent = c.number;
      cubicleSelect.appendChild(opt);
    }
    cubHint.textContent = list.length + " cubicle(s) available.";

    // Preselect in edit case
    {% if form_data and form_data.cubicle_no %}
      cubicleSelect.value = "{{ form_data.cubicle_no }}";
    {% endif %}
  }

  roomSelect.addEventListener("change", populateCubicles);
  window.addEventListener("DOMContentLoaded", () => {
    if (roomSelect.value) {
      populateCubicles();
    }
  });
</script>
{% endblock %}
