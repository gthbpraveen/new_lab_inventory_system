{% extends "login_home.html" %}
{% block title %}IT Equipment Assignment{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">

  <h2 class="text-2xl font-bold text-indigo-800 mb-6">
    IT Equipment Assignment for {{ student.name }} ({{ student.roll }})
  </h2>

<!-- Assigned Equipment History -->
<div class="mb-8 bg-white rounded-xl shadow p-4 border border-gray-200">
  <h3 class="text-xl font-semibold text-gray-800 mb-3">Currently Assigned</h3>
  {% if student_equipment %}
  <table class="min-w-full text-center border">
    <thead class="bg-gray-100 text-gray-700">
      <tr>
        <th class="px-4 py-2 border-b">Category</th>
        <th class="px-4 py-2 border-b">Serial</th>
        <th class="px-4 py-2 border-b">Model</th>
        <th class="px-4 py-2 border-b">Location</th>
        <th class="px-4 py-2 border-b">Intender</th>
        <th class="px-4 py-2 border-b">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for eq in student_equipment %}
      <tr class="hover:bg-gray-50">
        <td class="px-4 py-2 border">{{ eq.category }}</td>
        <td class="px-4 py-2 border">{{ eq.serial_number }}</td>
        <td class="px-4 py-2 border">{{ eq.manufacturer }} {{ eq.model }}</td>
        <td class="px-4 py-2 border">{{ eq.location }}</td>
        <td class="px-4 py-2 border">{{ eq.intender_name }}</td>
        <td class="px-4 py-2 border">
          <form method="post" id="returnForm-{{ eq.id }}">
            <input type="hidden" name="return_equipment_id" value="{{ eq.id }}">
            <button type="button"
                    class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700"
                    data-equipment="{{ eq.serial_number }}"
                    onclick="openConfirmModal({{ eq.id }}, '{{ eq.serial_number }}')">
              Return
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="text-gray-500">No equipment currently assigned.</p>
  {% endif %}
</div>

  <!-- Filter Form -->
  <form method="get" class="mb-6 grid grid-cols-2 gap-6 bg-white p-4 rounded-xl shadow border border-gray-200">
    
    <!-- Location Dropdown -->
    <div>
      <label class="block mb-2">Location</label>
      <select id="location" name="location"
        class="block w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-yellow-500">
        <option value="">-- Select Location --</option>

        <optgroup label="Labs">
          {% set lab_list = [
            'CS-107','CS-108','CS-109',
            'CS-207','CS-208','CS-209',
            'CS-317','CS-318','CS-319','CS-320',
            'CS-411','CS-412'
          ] %}
          {% for l in lab_list %}
            <option value="{{l}}" {% if request.args.get('location')==l %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </optgroup>

        <optgroup label="Other Locations">
          {% set other_locations = [
            'CSE Office','CSE Store','Institute Datacenter','SmartRack'
          ] %}
          {% for o in other_locations %}
            <option value="{{o}}" {% if request.args.get('location')==o %}selected{% endif %}>{{o}}</option>
          {% endfor %}
        </optgroup>
      </select>
    </div>

    <!-- Intender Dropdown -->
    <div>
      <label class="block mb-2">Select Faculty / Staff</label>
      <select id="intender_name" name="intender_name"
        class="block w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-green-500">
        <option value="">-- Select Faculty / Staff --</option>

        <optgroup label="Faculty">
          {% set faculty_list = [
            'Antony Franklin', 'Ashish Mishra', 'Bheemarjuna Reddy Tamma',
    'KrishnaMohan C', 'Saketha Nath J', 'Jyothi Vedurada',
    'Kotaro Kataoka', 'PandurangaRao M.V', 'Manish Singh',
    'Maria Francis', 'Maunendra Sankar Desarkar', 'Aravind N.R',
    'Nitin Saurabh', 'Praveen Tammana', 'Rajesh Kedia',
    'Rakesh Venkat', 'Ramakrishna Upadrasta', 'Rameshwar Pratap',
    'Rogers Mathew', 'Sathya Peri', 'Saurabh Kumar',
    'Shirshendu Das', 'Sobhan Babu', 'Srijith P. K.',
    'Subrahmanyam Kalyanasundaram', 'Vineeth N. Balasubramanian',
    'Abhijit Das', 'Sandipan D', 'Anupam Sanghi'
          ] %}
          {% for f in faculty_list %}
            <option value="{{f}}" {% if request.args.get('intender_name')==f %}selected{% endif %}>{{f}}</option>
          {% endfor %}
        </optgroup>

        <optgroup label="Staff">
          {% set staff_list = [
            'Praveen Kumar G','Shiva Kumar Reddy','Sunitha M',
          'Nikith Reddy','Vijay Chakravarthy','Syam N', 'Jathin S'
          ] %}
          {% for s in staff_list %}
            <option value="{{s}}" {% if request.args.get('intender_name')==s %}selected{% endif %}>{{s}}</option>
          {% endfor %}
        </optgroup>
      </select>
    </div>

    <!-- Submit -->
    <div class="col-span-2 flex justify-end">
      <button type="submit"
        class="bg-indigo-600 text-white px-6 py-2 rounded-lg shadow hover:bg-indigo-700">
        Search
      </button>
    </div>
  </form>

  <!-- Equipment by Status (Shown Only After Filter) -->
<!-- Equipment by Status (Only Available after search) -->
{% if request.args.get('location') or request.args.get('intender_name') %}
  <div class="bg-white rounded-xl shadow p-4 border border-gray-200 mb-6">
    <h3 class="text-xl font-semibold text-gray-800 mb-3">Available Equipment</h3>
    {% if available_equipment %}
    <table class="min-w-full text-center border">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="px-4 py-2 border-b">Category</th>
          <th class="px-4 py-2 border-b">Serial</th>
          <th class="px-4 py-2 border-b">Model</th>
          <th class="px-4 py-2 border-b">Location</th>
          <th class="px-4 py-2 border-b">Intender</th>
          <th class="px-4 py-2 border-b">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for eq in available_equipment %}
        <tr>
          <td class="px-4 py-2 border">{{ eq.category }}</td>
          <td class="px-4 py-2 border">{{ eq.serial_number }}</td>
          <td class="px-4 py-2 border">{{ eq.manufacturer }} {{ eq.model }}</td>
          <td class="px-4 py-2 border">{{ eq.location }}</td>
          <td class="px-4 py-2 border">{{ eq.intender_name }}</td>
          <td class="px-4 py-2 border">
            <form method="post">
              <input type="hidden" name="equipment_id" value="{{ eq.id }}">
              <input type="date" name="issue_date" class="border px-2 py-1 rounded">
              <input type="date" name="expected_return" class="border px-2 py-1 rounded">
              <button type="submit"
                      class="ml-2 bg-green-600 text-white px-3 py-1 rounded">
                Assign
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-gray-500">No available equipment found.</p>
    {% endif %}
  </div>
{% endif %}

  <div class="mt-6">
    <a href="{{ url_for('allotment_options', roll=student.roll) }}"
       class="text-indigo-600 hover:underline">‚Üê Back to Allotment Hub</a>
  </div>

</div>
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirm Return</h3>
    <p class="text-gray-600 mb-6">
      Are you sure you want to return <span id="equipmentName" class="font-bold"></span>?
    </p>
    <div class="flex justify-end space-x-3">
      <button onclick="closeConfirmModal()"
              class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
        Cancel
      </button>
      <button id="confirmBtn"
              class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
        Yes, Return
      </button>
    </div>
  </div>
</div>
<script>
  let selectedFormId = null;

  function openConfirmModal(equipmentId, serial) {
    selectedFormId = "returnForm-" + equipmentId;
    document.getElementById("equipmentName").textContent = serial;
    document.getElementById("confirmModal").classList.remove("hidden");
    document.getElementById("confirmModal").classList.add("flex");
  }

  function closeConfirmModal() {
    document.getElementById("confirmModal").classList.add("hidden");
    document.getElementById("confirmModal").classList.remove("flex");
  }

  document.getElementById("confirmBtn").addEventListener("click", function () {
    if (selectedFormId) {
      document.getElementById(selectedFormId).submit();
    }
  });
</script>
{% endblock %}
