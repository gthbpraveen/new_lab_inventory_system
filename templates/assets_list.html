{% extends "login_home.html" %}
{% block title %}Workstation Assets{% endblock %}

{% block content %}
<section class="py-10">
  <div class="max-w-7xl mx-auto px-6">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-3xl font-bold text-indigo-700">Workstation Assets</h2>
      {% if current_user.role != "student" %}
      <a href="{{ url_for('asset_new') }}" 
         class="bg-green-600 text-white px-4 py-2 rounded-md shadow hover:bg-green-700">
        + Add Asset
      </a>
      {% endif %}
    </div>

    <!-- Filter Form -->
    <form method="get" class="flex flex-wrap items-end gap-4 bg-blue-50 p-4 rounded-lg mb-6">
      {% if roll %}
        <input type="hidden" name="roll" value="{{ roll }}">
      {% endif %}
      {% if current_user.role != "student" %}
      <div>
        <label for="status" class="block text-gray-700 font-medium mb-1">Status</label>
        <select name="status" id="status" class="border rounded-md px-3 py-2">
          <option value="">All</option>
          <option value="Available" {% if status=="Available" %}selected{% endif %}>Available</option>
          <option value="Issued" {% if status=="Issued" %}selected{% endif %}>Issued</option>
          <option value="Retired" {% if status=="Retired" %}selected{% endif %}>Retired</option>
          <option value="Scrapped" {% if status=="Scrapped" %}selected{% endif %}>Scrapped</option>
        </select>
      </div>
      {% endif %}

      <div>
        <label for="location" class="block text-gray-700 font-medium mb-1">Location</label>
        <select name="location" id="location" class="border rounded-md px-3 py-2">
          <option value="">All</option>
          {% for loc in locations %}
            <option value="{{ loc }}" {% if location==loc %}selected{% endif %}>{{ loc }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="indenter" class="block text-gray-700 font-medium mb-1">Indenter</label>
        <select name="indenter" id="indenter" class="border rounded-md px-3 py-2">
          <option value="">All</option>
          {% for ind in indenters %}
            <option value="{{ ind }}" {% if indenter==ind %}selected{% endif %}>{{ ind }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="flex-1">
        <label for="search" class="block text-gray-700 font-medium mb-1">Search</label>
        <input type="text" name="search" id="search" value="{{ search }}" 
               placeholder="Search by Serial / Model / Manufacturer"
               class="border rounded-md px-3 py-2 w-full">
      </div>

      <div class="flex gap-2">
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow">
          Apply
        </button>
        <a href="{{ url_for('assets_list') }}" 
           class="bg-gray-400 text-white px-4 py-2 rounded-md shadow hover:bg-gray-500">
          Clear
        </a>
      </div>
    </form>

    <!-- Assets Table -->
    <div class="overflow-x-auto bg-white shadow rounded-lg">
      <table class="w-full text-sm text-left border border-gray-300 min-w-[900px]">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="p-3 border">S.No</th>
            <th class="p-3 border">Dept_code</th>
            <th class="p-3 border">Manufacturer</th>
            <th class="p-3 border">Model</th>
            <th class="p-3 border">Source of Fund</th>
            <th class="p-3 border">Status</th>
            {% if current_user.role != "student" %}
            <th class="p-3 border">Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for a in assets %}
          <tr class="border-b hover:bg-gray-50">
            <td class="p-3">{{ loop.index }}</td>
            <td class="p-3">
              <a href="#" class="text-indigo-600 hover:underline"
                 onclick="document.getElementById('details-{{ a.id }}').classList.toggle('hidden'); return false;">
                {{ a.department_code }}
              </a>
            </td>
            <td class="p-3">{{ a.manufacturer }}</td>
            <td class="p-3">{{ a.model }}</td>
            <td class="p-3">{{ a.source_of_fund or '—' }}</td>
            <td class="p-3">
  {% if a.status == "Available" %}
    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 border border-green-300">
      Available
    </span>
  {% elif a.status == "Issued" %}
    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 border border-blue-300">
      Issued
    </span>
  {% elif a.status == "Retired" %}
    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 border border-yellow-300">
      Retired
    </span>
  {% elif a.status == "Scrapped" %}
    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800 border border-red-300">
      Scrapped
    </span>
  {% else %}
    {{ a.status or "—" }}
  {% endif %}
</td>
      {% if current_user.role != "student" %}
<td class="p-3 space-x-2">

  {# simple flags to control buttons #}
  {% set can_edit   = a.status in ["Available", "Issued", "Retired"] %}
  {% set can_retire = a.status == "Available" %}
  {% set can_unretire = a.status == "Retired" %}
  {% set can_scrap  = a.status in ["Available", "Retired"] %}
  {% set can_clone  = a.status in ["Available", "Retired"] %}
  {% set can_delete = (not a.assignments or a.assignments|length == 0) 
                      and a.status in ["Available", "Retired"] %}

  {# Edit always allowed except maybe scrapped #}
  {% if can_edit %}
    <a href="{{ url_for('asset_edit', asset_id=a.id) }}" class="text-indigo-600 hover:underline">Edit</a>
  {% endif %}

  {# Retire #}
  {% if can_retire %}
    <form id="retire-form-{{ a.id }}" 
          action="{{ url_for('asset_retire', asset_id=a.id) }}" 
          method="post" class="inline"
          onsubmit="return confirmRetire({{ a.id }});">
      <input type="hidden" name="reason" id="retire-reason-{{ a.id }}">
      <button type="submit" class="text-yellow-700 hover:underline">
        Retire
      </button>
    </form>
  {% endif %}

  {# Unretire #}
  {% if can_unretire %}
    <form action="{{ url_for('asset_unretire', asset_id=a.id) }}" 
          method="post" class="inline"
          onsubmit="return confirm('Un-retire this asset and make it Available?');">
      <button type="submit" class="text-green-700 hover:underline">
        Unretire
      </button>
    </form>
  {% endif %}

  {# Scrap #}
  {% if can_scrap %}
    <form id="scrap-form-{{ a.id }}" 
          action="{{ url_for('asset_scrap', asset_id=a.id) }}" 
          method="post" class="inline"
          onsubmit="return confirmScrap({{ a.id }});">
      <input type="hidden" name="reason" id="scrap-reason-{{ a.id }}">
      <button type="submit" class="text-red-700 hover:underline">
        Scrap
      </button>
    </form>
  {% endif %}

  {# Clone #}
  {% if can_clone %}
    <a href="{{ url_for('clone_workstation', asset_id=a.id) }}" 
       class="text-purple-700 hover:underline">Clone</a>
  {% endif %}

  {# Delete #}
  {% if can_delete %}
    <form action="{{ url_for('asset_delete', asset_id=a.id) }}" 
          method="post" class="inline"
          onsubmit="return confirm('Are you sure you want to permanently delete this asset?');">
      <button type="submit" class="text-red-600 hover:underline">
        Delete
      </button>
    </form>
  {% endif %}

</td>
{% endif %}

            
          </tr>

          <!-- Expanded details row: show ALL workstation details -->
          <tr id="details-{{ a.id }}" class="hidden bg-gray-50">
            <td colspan="{% if current_user.role != 'student' %}7{% else %}6{% endif %}" class="p-4">
              <table class="w-full text-sm border border-gray-300">
                <!-- Identity -->
                <tr><th class="p-2 border bg-gray-100">Department Code</th><td class="p-2 border">{{ a.department_code }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Manufacturer</th><td class="p-2 border">{{ a.manufacturer }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Other Manufacturer</th><td class="p-2 border">{{ a.otherManufacturer or '—' }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Model</th><td class="p-2 border">{{ a.model }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Serial</th><td class="p-2 border">{{ a.serial }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">OS</th><td class="p-2 border">{{ a.os or '—' }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Other OS</th><td class="p-2 border">{{ a.otherOs or '—' }}</td></tr>

                <!-- CPU / GPU -->
                <tr>
                  <th class="p-2 border bg-gray-100">Processor(s)</th>
                  <td class="p-2 border">
                    {% set procs = a.get_processors() %}
                    {% if procs %}
                      {% for p in procs %}
                        {{ p.name or 'Unknown CPU' }}{% if p.cores %} ({{ p.cores }} cores){% endif %}{% if not loop.last %}, {% endif %}
                      {% endfor %}
                    {% else %}
                      {{ a.processor or '—' }}
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <th class="p-2 border bg-gray-100">GPU(s)</th>
                  <td class="p-2 border">
                    {% set gpus = a.get_gpus() %}
                    {% if gpus %}
                      {% for g in gpus %}
                        {{ g.name or 'Unknown GPU' }}{% if g.vram %} ({{ g.vram }} GB VRAM){% endif %}{% if not loop.last %}, {% endif %}
                      {% endfor %}
                    {% else %}
                      {% if a.gpu %}
                        {{ a.gpu }}{% if a.vram %} ({{ a.vram }} GB VRAM){% endif %}
                      {% else %}
                        —
                      {% endif %}
                    {% endif %}
                  </td>
                </tr>

                <!-- Memory & Storage -->
                <tr>
                  <th class="p-2 border bg-gray-100">RAM</th>
                  <td class="p-2 border">
                    {% if a.ram or a.ram_size_gb %}
                      {{ a.ram or '' }}{% if a.ram_size_gb %} ({{ a.ram_size_gb }} GB){% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
                <tr><th class="p-2 border bg-gray-100">Other RAM</th><td class="p-2 border">{{ a.otherRam or '—' }}</td></tr>
                <tr>
                  <th class="p-2 border bg-gray-100">Storage 1</th>
                  <td class="p-2 border">
                    {% if a.storage_type1 or a.storage_capacity1 %}
                      {{ a.storage_type1 or '—' }}
                      {% if a.storage_capacity1 %} — {{ a.storage_capacity1 }} GB{% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <th class="p-2 border bg-gray-100">Storage 2</th>
                  <td class="p-2 border">
                    {% if a.storage_type2 or a.storage_capacity2 %}
                      {{ a.storage_type2 or '—' }}
                      {% if a.storage_capacity2 %} — {{ a.storage_capacity2 }} GB{% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>

                <!-- Peripherals & Network -->
                <tr><th class="p-2 border bg-gray-100">Keyboard</th><td class="p-2 border">{{ a.keyboard_provided or '—' }}{% if a.keyboard_details %} - {{ a.keyboard_details }}{% endif %}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Mouse</th><td class="p-2 border">{{ a.mouse_provided or '—' }}{% if a.mouse_details %} - {{ a.mouse_details }}{% endif %}</td></tr>
                <tr>
                  <th class="p-2 border bg-gray-100">Monitor</th>
                  <td class="p-2 border">
                    {% if a.monitor_provided or a.monitor_details or a.monitor_size or a.monitor_serial %}
                      {{ a.monitor_provided or '—' }}{% if a.monitor_details %} - {{ a.monitor_details }}{% endif %}
                      {% if a.monitor_size %} ({{ a.monitor_size }}){% endif %}
                      {% if a.monitor_serial %} SN: {{ a.monitor_serial }}{% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
                <tr><th class="p-2 border bg-gray-100">MAC Address</th><td class="p-2 border">{{ a.mac_address or '—' }}</td></tr>

                <!-- PO & Warranty -->
                <tr><th class="p-2 border bg-gray-100">PO Date</th><td class="p-2 border">{{ a.po_date or '—' }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">PO Number</th><td class="p-2 border">{{ a.po_number or '—' }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Source of Fund</th><td class="p-2 border">{{ a.source_of_fund or '—' }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Warranty Start</th><td class="p-2 border">{{ a.warranty_start or '—' }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Warranty Expiry</th><td class="p-2 border">{{ a.warranty_expiry or '—' }}</td></tr>

                {% if a.po_invoice_filename %}
                <tr>
                  <th class="p-2 border bg-gray-100">PO / Invoice File</th>
                  <td class="p-2 border">
                    <a href="{{ url_for('download_po_invoice', filename=a.po_invoice_filename) }}"
                       class="text-indigo-600 hover:underline">
                      {{ a.po_invoice_filename }}
                    </a>
                  </td>
                </tr>
                {% endif %}

                <!-- Vendor & Ownership -->
                <tr><th class="p-2 border bg-gray-100">Vendor</th><td class="p-2 border">{{ a.vendor_company or '—' }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Vendor Contact Person</th><td class="p-2 border">{{ a.vendor_contact_person or '—' }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Vendor Mobile</th><td class="p-2 border">{{ a.vendor_mobile or '—' }}</td></tr>

                <tr><th class="p-2 border bg-gray-100">Status</th><td class="p-3">
  {% if a.status == "Available" %}
    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 border border-green-300">
      Available
    </span>
  {% elif a.status == "Issued" %}
    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 border border-blue-300">
      Issued
    </span>
  {% elif a.status == "Retired" %}
    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 border border-yellow-300">
      Retired
    </span>
  {% elif a.status == "Scrapped" %}
    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800 border border-red-300">
      Scrapped
    </span>
  {% else %}
    {{ a.status or "—" }}
  {% endif %}
</td>
</tr>
                <tr><th class="p-2 border bg-gray-100">Location</th><td class="p-2 border">{{ a.location }}</td></tr>
                <tr><th class="p-2 border bg-gray-100">Indenter</th><td class="p-2 border">{{ a.indenter }}</td></tr>
               <tr>
  <th class="p-2 border bg-gray-100 align-top">Status History</th>
  <td class="p-2 border">
    {% if a.status_logs %}
      <ul class="list-disc list-inside space-y-1">
        {% for log in a.status_logs|sort(attribute="changed_at", reverse=True) %}
          <li>
            <strong>{{ log.old_status }} → {{ log.new_status }}</strong>
            {% if log.reason %} — {{ log.reason }}{% endif %}
            {% if log.changed_by %} (by {{ log.changed_by }}){% endif %}
            {% if log.changed_at %} on {{ log.changed_at.strftime("%Y-%m-%d %H:%M") }}{% endif %}
          </li>
        {% endfor %}
      </ul>
      <a href="{{ url_for('machines_history', asset_id=a.id) }}"
         class="text-xs text-indigo-700 hover:underline mt-1 inline-block">
        View full history →
      </a>
    {% else %}
      —
    {% endif %}
  </td>
</tr>


                <tr><th class="p-2 border bg-gray-100">Created At</th><td class="p-2 border">{{ a.created_at or '—' }}</td></tr>
              </table>
            </td>
          </tr>

          {% else %}
          <tr>
            <td colspan="{% if current_user.role != 'student' %}7{% else %}6{% endif %}" 
                class="text-center py-4 text-gray-500">No assets found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if roll %}
    <div class="mt-6">
      <a href="{{ url_for('allotment_options', roll=roll) }}" 
         class="bg-purple-600 text-white px-4 py-2 rounded-md shadow hover:bg-purple-700">
        ← Back to Allotment Options
      </a>
    </div>
    {% endif %}
  </div>
</section>
<script>
  function confirmRetire(id) {
    const reason = prompt("Enter reason for retiring this asset:");
    if (reason === null) {
      // user pressed Cancel
      return false;
    }
    if (!reason.trim()) {
      alert("Reason is required to retire the asset.");
      return false;
    }
    const input = document.getElementById("retire-reason-" + id);
    if (input) {
      input.value = reason.trim();
    }
    return confirm("Retire this asset?");
  }

  function confirmScrap(id) {
    const reason = prompt("Enter reason for scrapping this asset:");
    if (reason === null) {
      return false;
    }
    if (!reason.trim()) {
      alert("Reason is required to scrap the asset.");
      return false;
    }
    const input = document.getElementById("scrap-reason-" + id);
    if (input) {
      input.value = reason.trim();
    }
    return confirm("Mark this asset as Scrapped?");
  }
</script>

{% endblock %}
