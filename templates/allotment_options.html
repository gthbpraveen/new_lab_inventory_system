{# templates/allotment_options.html - unified for student / staff / faculty #}
{% extends "login_home.html" %}
{% block title %}Allotment Hub{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">

  {# Determine role and person shortcuts #}
  {% set role = 'student' if student else ('staff' if staff else ('faculty' if faculty else None)) %}
  {% if not role %}
    <div class="bg-red-50 border border-red-200 text-red-700 p-6 rounded">No person supplied to template.</div>
  {% else %}

  {# person object for simpler references #}
  {% set person = student or staff or faculty %}
  {% set person_id = person.roll if role == 'student' else person.id %}
  {% set person_name = person.name %}
  {% set person_label_1 = 'Roll' if role == 'student' else ( 'Staff ID' if role=='staff' else 'Faculty ID' ) %}
  {% set person_label_2 = 'Course' if role == 'student' else 'Designation' %}
  {% set space_label = 'Cubicle' if role == 'student' else 'Room' %}
  {% set current_space = current_cubicle if role == 'student' else current_room %}

  <!-- Header card -->
  <div class="bg-white/90 backdrop-blur shadow-xl rounded-2xl border border-gray-200 overflow-hidden mb-8">
    <div class="bg-gradient-to-r from-indigo-600 via-indigo-500 to-indigo-700 h-2"></div>
    <div class="p-8">
      <div class="flex flex-col md:flex-row items-center justify-between gap-8">

        <!-- Left: Person Details -->
        <div class="md:w-1/2 w-full">
          <div class="flex items-center gap-4">
            <div class="h-14 w-14 rounded-full bg-indigo-100 flex items-center justify-center shadow">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M20 21a8 8 0 10-16 0"/>
                <circle cx="12" cy="8" r="4" stroke-width="1.6"/>
              </svg>
            </div>
            <div>
              <h2 class="text-3xl font-extrabold text-indigo-800 tracking-wide">{{ person_name }}</h2>
              <p class="mt-1 text-gray-700">
                <span class="inline-flex items-center gap-2 mr-3">
                  <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700 border border-indigo-100">{{ person_label_1 }}</span>
                  <span class="font-semibold text-gray-900">{{ person.staff_id if role=='staff' else person.faculty_id }}</span>
                </span>
                <span class="inline-flex items-center gap-2">
                  <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100">{{ person_label_2 }}</span>
                  <span class="text-indigo-700 font-medium">
                    {% if role == 'student' %}
                      {{ person.course }} <span class="text-gray-500">(Year {{ person.year }})</span>
                    {% else %}
                      {{ person.designation or '‚Äî' }}
                    {% endif %}
                  </span>
                </span>
              </p>
            </div>
          </div>
        </div>

        <!-- Right: Current Space -->
        <div class="md:w-1/2 w-full">
          {% if current_space %}
            {% if role == 'student' %}
              <div class="relative overflow-hidden rounded-xl border border-indigo-100 bg-gradient-to-br from-indigo-600 to-indigo-800 text-white shadow-lg">
                <div class="absolute -right-8 -top-8 h-24 w-24 rounded-full bg-white/10"></div>
                <div class="absolute -left-10 -bottom-10 h-28 w-28 rounded-full bg-white/10"></div>
                <div class="p-6 flex items-center justify-between gap-4">
                  <div>
                    <p class="text-xs uppercase tracking-wider text-indigo-200">Current Allocation</p>
                    <p class="mt-1 text-lg text-indigo-100">Room</p>
                    <p class="text-2xl font-bold">{{ current_space.room_lab.name }}</p>
                  </div>
                  <div class="shrink-0">
                    <div class="h-20 w-20 rounded-2xl bg-white text-indigo-700 flex flex-col items-center justify-center shadow-md">
                      <span class="text-[10px] uppercase tracking-wider text-indigo-500">{{ space_label }}</span>
                      <span class="text-3xl leading-none font-extrabold">{{ current_space.number }}</span>
                    </div>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="relative overflow-hidden rounded-xl border border-indigo-100 bg-gradient-to-br from-indigo-600 to-indigo-800 text-white shadow-lg p-6">
                <div>
                  <p class="text-xs uppercase tracking-wider text-indigo-200">Current Office</p>
                  <p class="mt-1 text-lg text-indigo-100">{{ space_label }}</p>
                  <p class="text-2xl font-bold">{{ current_space }}</p>
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="rounded-xl border border-dashed border-gray-300 bg-gray-50 text-center p-6">
              <p class="text-gray-500 italic">No {{ space_label|lower }} assigned</p>
            </div>
          {% endif %}
        </div>

      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="bg-white rounded-2xl shadow p-6 border border-gray-200">
    <h3 class="text-xl font-bold text-indigo-800 mb-4">‚ö° Quick Allotment Options</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      {# Space link differs for student vs staff/faculty #}
      <a href="{% if role=='student' %}{{ url_for('space_allocation', roll=person.roll) }}{% elif role=='staff' %}{{ url_for('space_allocation_staff', pid=person.id) }}{% else %}{{ url_for('space_allocation_faculty', pid=person.id) }}{% endif %}"
         class="group block rounded-xl border border-blue-100 bg-gradient-to-br from-blue-600 to-blue-700 text-white p-6 shadow hover:shadow-lg transition-transform">
        <div class="flex items-center justify-center mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 opacity-95" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M6 18h12M8 12h8v6H8v-6zM8 4h8v6H8z"/>
          </svg>
        </div>
        <h4 class="font-semibold text-lg">{% if role=='student' %}Allocate / Reassign Cubicle{% else %}Allocate / Reassign Office{% endif %}</h4>
        <p class="mt-1 text-sm text-blue-100/90">{% if role=='student' %}Assign or move a student to a new cubicle{% else %}Assign or move to an office{% endif %}</p>
      </a>

      {# Workstations link uses generic endpoints you already created/aliased #}
      <a href="{% if role=='student' %}{{ url_for('assignments_list', roll=person.roll) }}{% elif role=='staff' %}{{ url_for('staff_assignments', sid=person.id) }}{% else %}{{ url_for('faculty_assignments', fid=person.id) }}{% endif %}"
         class="group block rounded-xl border border-emerald-100 bg-gradient-to-br from-emerald-600 to-emerald-700 text-white p-6 shadow hover:shadow-lg transition-transform">
        <div class="flex items-center justify-center mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 opacity-95" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <rect x="3" y="4" width="18" height="12" rx="2"/><path d="M8 20h8" stroke-linecap="round"/>
          </svg>
        </div>
        <h4 class="font-semibold text-lg">Workstation Assignments</h4>
        <p class="mt-1 text-sm text-emerald-100/90">View or issue workstations</p>
      </a>

      {# IT Equipment link #}
      <a href="{% if role=='student' %}{{ url_for('it_equipment_assign', roll=person.roll) }}{% elif role=='staff' %}{{ url_for('it_equipment_assign_staff', pid=person.id) }}{% else %}{{ url_for('it_equipment_assign_faculty', pid=person.id) }}{% endif %}"
         class="group block rounded-xl border border-purple-100 bg-gradient-to-br from-purple-600 to-purple-700 text-white p-6 shadow hover:shadow-lg transition-transform">
        <div class="flex items-center justify-center mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 opacity-95" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <rect x="2.5" y="6" width="19" height="12" rx="2"/><path d="M8 18v2h8v-2"/>
          </svg>
        </div>
        <h4 class="font-semibold text-lg">IT Equipment Assignments</h4>
        <p class="mt-1 text-sm text-purple-100/90">Manage devices & accessories</p>
      </a>
    </div>
  </div>

  <!-- Tabs -->
  <div class="mt-8">
    <nav class="flex flex-wrap gap-2">
      <button data-tab="profile" class="tab-link px-4 py-2 rounded-full border border-indigo-200 text-indigo-700 bg-indigo-50 font-medium">Profile</button>
      <button data-tab="space" class="tab-link px-4 py-2 rounded-full border border-gray-200 text-gray-600 hover:bg-gray-50">Space</button>
      <button data-tab="workstations" class="tab-link px-4 py-2 rounded-full border border-gray-200 text-gray-600 hover:bg-gray-50">Workstations</button>
      <button data-tab="equipment" class="tab-link px-4 py-2 rounded-full border border-gray-200 text-gray-600 hover:bg-gray-50">Equipment</button>
    </nav>
  </div>

  <!-- Tab Contents -->
  <div id="tab-contents" class="mt-4">

    <!-- Profile -->
    <div id="profile" class="tab-content">
      <div class="bg-white rounded-2xl shadow p-6 border border-gray-200 relative">
        <h3 class="text-xl font-bold text-indigo-800 mb-4">
          {% if role=='student' %}üéì Student Information{% elif role=='staff' %}üßë‚Äçüîß Staff Information{% else %}üë®‚Äçüè´ Faculty Information{% endif %}
        </h3>

        {# Edit link: choose correct edit endpoint names in your app.py #}
        <a href="{% if role=='student' %}{{ url_for('edit_student', roll=person.roll) }}{% elif role=='staff' %}{{ url_for('staff_edit', sid=person.id) }}{% else %}{{ url_for('faculty_edit', fid=person.id) }}{% endif %}"
           class="absolute top-6 right-6 inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-1.5 rounded-lg">
          ‚úèÔ∏è Edit
        </a>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-800 mt-6">
          {% if role=='student' %}
            <p><strong>Roll:</strong> {{ person.roll }}</p>
            <p><strong>Name:</strong> {{ person.name }}</p>
            <p><strong>Course:</strong> {{ person.course }}</p>
            <p><strong>Year:</strong> {{ person.year }}</p>
            <p><strong>Joining Year:</strong> {{ person.joining_year }}</p>
            <p><strong>Faculty:</strong> {{ person.faculty }}</p>
            <p><strong>Email:</strong> {{ person.email }}</p>
            <p><strong>Phone:</strong> {{ person.phone or "‚Äî" }}</p>
          {% else %}
            <p><strong>{{ person_label_1 }}:</strong> {{ person.staff_id if role=='staff' else person.faculty_id }}</p>
            <p><strong>Name:</strong> {{ person.name }}</p>
            <p><strong>Designation:</strong> {{ person.designation or '‚Äî' }}</p>
            <p><strong>Room:</strong> {{ person.room or '‚Äî' }}</p>
            <p><strong>Email:</strong> {{ person.email or '‚Äî' }}</p>
            <p><strong>Phone:</strong> {{ person.mobile or '‚Äî' }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Space -->
    <div id="space" class="tab-content hidden">
      <div class="bg-white rounded-2xl shadow p-6 border border-gray-200">
        <h3 class="text-xl font-bold text-indigo-800 mb-4">{% if role=='student' %}üè¢ Space Allocation{% else %}üè¢ Office Allocation{% endif %}</h3>

        {% if current_space %}
          {% if role=='student' %}
            <div class="rounded-lg bg-indigo-50 border border-indigo-100 p-4 text-indigo-900">
              <span class="font-semibold">Current:</span>
              <span class="ml-1">{{ current_space.room_lab.name }}</span>,
              <span class="ml-1">Cubicle <span class="font-semibold">{{ current_space.number }}</span></span>
            </div>
          {% else %}
            <div class="rounded-lg bg-indigo-50 border border-indigo-100 p-4 text-indigo-900">
              <span class="font-semibold">Current:</span>
              <span class="ml-1">{{ current_space }}</span>
            </div>
          {% endif %}
        {% else %}
          <p class="text-gray-500 mb-3">‚ùå No current {{ space_label|lower }} allocated</p>
        {% endif %}

        <a href="{% if role=='student' %}{{ url_for('space_allocation', roll=person.roll) }}{% elif role=='staff' %}{{ url_for('space_allocation_staff', pid=person.id) }}{% else %}{{ url_for('space_allocation_faculty', pid=person.id) }}{% endif %}"
           class="mt-4 inline-flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
          <span>Manage {{ space_label }}</span>
        </a>
      </div>
    </div>

    <!-- Workstations -->
    <div id="workstations" class="tab-content hidden">
      <div class="bg-white rounded-2xl shadow p-6 border border-gray-200">
        <h3 class="text-xl font-bold text-indigo-800 mb-4">üíª Workstation Assignments</h3>

        <h4 class="font-semibold text-gray-800 mb-2">Current</h4>
        {% if workstation_active %}
          <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full text-center">
              <thead class="bg-gray-50 text-gray-700">
                <tr>
                  <th class="px-4 py-2 border-b">Name</th>
                  <th class="px-4 py-2 border-b">Category</th>
                  <th class="px-4 py-2 border-b">Serial</th>
                  <th class="px-4 py-2 border-b">Status</th>
                  <th class="px-4 py-2 border-b">Assigned Date</th>
                  <th class="px-4 py-2 border-b">Return Date</th>
                  <th class="px-4 py-2 border-b">Assigned By</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                {% for ws in workstation_active %}
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2">{{ ws.asset.manufacturer or ws.asset.otherManufacturer }}</td>
                  <td class="px-4 py-2">{{ ws.asset.model }}</td>
                  <td class="px-4 py-2">{{ ws.asset.serial }}</td>
                  <td class="px-4 py-2"><span class="text-green-600 font-semibold">Active</span></td>
                  <td class="px-4 py-2">{{ ws.issue_date[:10] if ws.issue_date else '‚Äî' }}</td>
                  <td class="px-4 py-2">{{ ws.system_required_till[:10] if ws.system_required_till else '‚Äî' }}</td>
                  <td class="px-4 py-2">
                    {% if role=='student' %}
                      {{ ws.student.cubicle.room_lab.staff_incharge if ws.student and ws.student.cubicle else '‚Äî' }}
                    {% else %}
                      {{ ws.assigned_by or '‚Äî' }}
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-gray-500 mb-4">No active workstations</p>
        {% endif %}

        <h4 class="font-semibold text-gray-800 mt-6 mb-2">History</h4>
        {% if workstation_history %}
          <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full text-center">
              <thead class="bg-gray-50 text-gray-700">
                <tr>
                  <th class="px-4 py-2 border-b">Name</th>
                  <th class="px-4 py-2 border-b">Category</th>
                  <th class="px-4 py-2 border-b">Serial</th>
                  <th class="px-4 py-2 border-b">Status</th>
                  <th class="px-4 py-2 border-b">Assigned Date</th>
                  <th class="px-4 py-2 border-b">Return Date</th>
                  <th class="px-4 py-2 border-b">Assigned By</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                {% for ws in workstation_history %}
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2">{{ ws.asset.manufacturer or ws.asset.otherManufacturer }}</td>
                  <td class="px-4 py-2">{{ ws.asset.model }}</td>
                  <td class="px-4 py-2">{{ ws.asset.serial }}</td>
                  <td class="px-4 py-2">
                    {% if ws.is_active %}<span class="text-green-600 font-semibold">Active</span>{% else %}<span class="text-red-600 font-semibold">Returned</span>{% endif %}
                  </td>
                  <td class="px-4 py-2">{{ ws.issue_date[:10] if ws.issue_date else '‚Äî' }}</td>
                  <td class="px-4 py-2">{{ ws.end_date[:10] if ws.end_date else '‚Äî' }}</td>
                  <td class="px-4 py-2">
                    {% if role=='student' %}
                      {{ ws.student.cubicle.room_lab.staff_incharge if ws.student and ws.student.cubicle else '‚Äî' }}
                    {% else %}
                      {{ ws.assigned_by or '‚Äî' }}
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-gray-500">No workstation history</p>
        {% endif %}

   <a href="
 {% if role=='student' %}
           {{ url_for('assignment_new',
                      owner_type='student',
                      student_roll=person.roll) }}
         {% elif role=='staff' %}
           {{ url_for('assignment_new',
                      owner_type='staff',
                      staff_id=person.id) }}
         {% else %}
           {{ url_for('assignment_new',
                      owner_type='faculty',
                      faculty_id=person.id) }}
         {% endif %}"
   class="mt-6 inline-flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
  Assign New Workstation
</a>

      </div>
    </div>

    <!-- Equipment -->
    <div id="equipment" class="tab-content hidden">
      <div class="bg-white rounded-2xl shadow p-6 border border-gray-200">
        <h3 class="text-xl font-bold text-indigo-800 mb-4">üñ•Ô∏è IT Equipment</h3>

        <!-- Current Equipment -->
        <h4 class="font-semibold text-gray-800 mb-2">Current</h4>
        {% if equipment_active %}
          <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full text-center">
              <thead class="bg-gray-50 text-gray-700">
                <tr>
                  <th class="px-4 py-2 border-b">Name</th>
                  <th class="px-4 py-2 border-b">Category</th>
                  <th class="px-4 py-2 border-b">Serial</th>
                  <th class="px-4 py-2 border-b">Status</th>
                  <th class="px-4 py-2 border-b">Assigned Date</th>
                  <th class="px-4 py-2 border-b">Return Date</th>
                  <th class="px-4 py-2 border-b">Assigned By</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                {% for eq in equipment_active %}
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2">{{ eq.name }}</td>
                  <td class="px-4 py-2">{{ eq.category }}</td>
                  <td class="px-4 py-2">{{ eq.serial_number }}</td>
                  <td class="px-4 py-2"><span class="text-green-600 font-semibold">Active</span></td>
                  <td class="px-4 py-2">{{ eq.assigned_date or '‚Äî' }}</td>
                  <td class="px-4 py-2">{{ eq.expected_return_date or '‚Äî' }}</td>
                  <td class="px-4 py-2">{{ eq.assigned_by or '‚Äî' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-gray-500 mb-4">No active equipment</p>
        {% endif %}

        <!-- Equipment History -->
        <h4 class="font-semibold text-gray-800 mt-6 mb-2">History</h4>
        {% if equipment_history %}
          <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full text-center">
              <thead class="bg-gray-50 text-gray-700">
                <tr>
                  <th class="px-4 py-2 border-b">Name</th>
                  <th class="px-4 py-2 border-b">Category</th>
                  <th class="px-4 py-2 border-b">Serial</th>
                  <th class="px-4 py-2 border-b">Status</th>
                  <th class="px-4 py-2 border-b">Assigned Date</th>
                  <th class="px-4 py-2 border-b">Return Date</th>
                  <th class="px-4 py-2 border-b">Assigned By</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                {% for eq in equipment_history %}
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2">{{ eq.equipment_obj.name if eq.equipment_obj else '‚Äî' }}</td>
                  <td class="px-4 py-2">{{ eq.equipment_obj.category if eq.equipment_obj else '‚Äî' }}</td>
                  <td class="px-4 py-2">{{ eq.equipment_obj.serial_number if eq.equipment_obj else '‚Äî' }}</td>
                  <td class="px-4 py-2">
                    {% if not eq.unassigned_date %}<span class="text-green-600 font-semibold">Active</span>{% else %}<span class="text-red-600 font-semibold">Returned</span>{% endif %}
                  </td>
                  <td class="px-4 py-2">{{ eq.assigned_date or '‚Äî' }}</td>
                  <td class="px-4 py-2">{{ eq.unassigned_date or '‚Äî' }}</td>
                  <td class="px-4 py-2">{{ eq.staff_incharge or '‚Äî' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-gray-500">No equipment history</p>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Bottom actions -->
  <div class="mt-10 flex justify-center gap-4">
    <a href="{% if role=='student' %}/allotted_roll_check{% elif role=='staff' %}{{ url_for('staff_directory') }}{% else %}{{ url_for('faculty_directory') }}{% endif %}" class="inline-flex items-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-800 px-5 py-2.5 rounded-lg shadow-sm transition">
      <span class="text-lg">‚Üê</span><span>Back</span>
    </a>
    <a href="{{ url_for('login_home') }}" class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg shadow transition">
      <span>üè†</span><span>Dashboard</span>
    </a>
  </div>

  {% endif %}
</div>

<!-- Tabs Script (same as before) -->
<script>
  const tabLinks = document.querySelectorAll(".tab-link");
  const tabContents = document.querySelectorAll(".tab-content");
  function setActiveTab(tab) {
    tabLinks.forEach(l => {
      l.classList.remove("bg-indigo-50","border-indigo-200","text-indigo-700","font-medium");
      l.classList.add("border-gray-200","text-gray-600");
      if (l.dataset.tab === tab) {
        l.classList.remove("border-gray-200","text-gray-600");
        l.classList.add("bg-indigo-50","border-indigo-200","text-indigo-700","font-medium");
      }
    });
    tabContents.forEach(c => c.classList.toggle("hidden", c.id !== tab));
  }
  tabLinks.forEach(link => link.addEventListener("click", () => setActiveTab(link.dataset.tab)));
  setActiveTab("profile");
</script>
{% endblock %}
