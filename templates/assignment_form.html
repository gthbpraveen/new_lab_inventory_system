{% extends "login_home.html" %}
{% block content %}
{% set owner_type = owner_type or 'student' %}
<div class="container mx-auto px-6 py-6">
  <h1 class="text-2xl font-bold text-indigo-800 mb-6">
    Assign Workstation
    {% if owner_type == "faculty" %}
      to Faculty
    {% elif owner_type == "staff" %}
      to Staff
    {% else %}
      to Student
    {% endif %}
  </h1>

  <!-- Filter Form -->
  <form method="get" class="flex flex-wrap items-end gap-4 bg-blue-50 p-4 rounded-lg mb-6">
    <input type="hidden" name="owner_type" value="{{ owner_type }}">

    {# preserve owner when filtering #}
    {% if owner_type == "student" and prefill_roll %}
      <input type="hidden" name="student_roll" value="{{ prefill_roll }}">
    {% elif owner_type == "faculty" and person %}
      <input type="hidden" name="faculty_id" value="{{ person.id }}">
    {% elif owner_type == "staff" and person %}
      <input type="hidden" name="staff_id" value="{{ person.id }}">
    {% endif %}

    <!-- Location -->
    <div>
      <label for="location" class="block text-gray-700 font-medium mb-1">Location</label>
      <select name="location" id="location" class="border rounded-md px-3 py-2">
        <option value="">All</option>
        {% for loc in locations %}
          <option value="{{ loc }}" {% if location == loc %}selected{% endif %}>{{ loc }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Indenter -->
    <div>
      <label for="indenter" class="block text-gray-700 font-medium mb-1">Indenter</label>
      <select name="indenter" id="indenter" class="border rounded-md px-3 py-2">
        <option value="">All</option>
        {% for ind in indenters %}
          <option value="{{ ind }}" {% if indenter == ind %}selected{% endif %}>{{ ind }}</option>
        {% endfor %}
      </select>
    </div>

    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow">
      Filter
    </button>
  </form>

  <!-- Assignment Form -->
  <form method="post" class="bg-white shadow rounded-lg p-6">
    <input type="hidden" name="owner_type" value="{{ owner_type }}">

    <div class="mb-4">
      <label for="workstation_id" class="block text-gray-700 font-medium mb-2">Available Workstations</label>
      <select name="workstation_id" id="workstation_id" required class="border rounded-md px-3 py-2 w-full">
        <option value="">Select a workstation</option>
        {% for a in assets %}
          <option value="{{ a.id }}">
            [{{ a.serial }}] {{ a.manufacturer }} {{ a.model }} ({{ a.location }} - {{ a.indenter }})
          </option>
        {% endfor %}
      </select>
    </div>

    {# ------- OWNER BLOCK ------- #}
    {% if owner_type == "faculty" and person %}
      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-2">Faculty</label>
        <div class="border rounded-md px-3 py-2 w-full bg-gray-100">
          {{ person.faculty_id }} — {{ person.name }}
        </div>
        <input type="hidden" name="faculty_id" value="{{ person.id }}">
      </div>

    {% elif owner_type == "staff" and person %}
      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-2">Staff</label>
        <div class="border rounded-md px-3 py-2 w-full bg-gray-100">
          {{ person.staff_id }} — {{ person.name }}
        </div>
        <input type="hidden" name="staff_id" value="{{ person.id }}">
      </div>

    {% else %}
      {# default / student case #}
      <div class="mb-4">
        <label for="student_roll" class="block text-gray-700 font-medium mb-2">Student Roll</label>
        <input type="text" name="student_roll" id="student_roll"
               value="{{ prefill_roll }}"
               class="border rounded-md px-3 py-2 w-full {% if prefill_roll %}bg-gray-100{% endif %}"
               {% if prefill_roll %}readonly{% endif %}
               required>
      </div>
    {% endif %}

    <div class="mb-4">
      <label for="issue_date" class="block text-gray-700 font-medium mb-2">Issue Date</label>
      <input type="date" name="issue_date" id="issue_date" required class="border rounded-md px-3 py-2 w-full">
    </div>

    <div class="mb-4">
      <label for="system_required_till" class="block text-gray-700 font-medium mb-2">Required Till</label>
      <input type="date" name="system_required_till" id="system_required_till" required class="border rounded-md px-3 py-2 w-full">
    </div>

    <div class="mb-4">
      <label for="remarks" class="block text-gray-700 font-medium mb-2">Remarks</label>
      <textarea name="remarks" id="remarks" rows="3" class="border rounded-md px-3 py-2 w-full"></textarea>
    </div>

    <div class="flex items-center gap-3 mt-6">
      <!-- Submit -->
      <button type="submit"
              class="bg-green-600 text-white px-4 py-2 rounded-md shadow hover:bg-green-700">
        Assign Asset
      </button>

      <!-- Back to Allotment -->
      {% if owner_type == "student" and prefill_roll %}
        <a href="{{ url_for('allotment_options', roll=prefill_roll) }}"
           class="bg-gray-500 text-white px-4 py-2 rounded-md shadow hover:bg-gray-600">
          Back to Allotment Options
        </a>
      {% elif owner_type == "faculty" and person %}
        <a href="{{ url_for('allotment_options_faculty', fid=person.id) }}"
           class="bg-gray-500 text-white px-4 py-2 rounded-md shadow hover:bg-gray-600">
          Back to Allotment Options
        </a>
      {% elif owner_type == "staff" and person %}
        <a href="{{ url_for('allotment_options_staff', sid=person.id) }}"
           class="bg-gray-500 text-white px-4 py-2 rounded-md shadow hover:bg-gray-600">
          Back to Allotment Options
        </a>
      {% endif %}

      <!-- Assignment List -->
      <a href="{{ url_for('assignments_list') }}"
         class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow hover:bg-indigo-700">
        View Assignment List
      </a>
    </div>
  </form>
</div>
{% endblock %}
