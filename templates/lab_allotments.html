{% extends "login_home.html" %}
{% block title %}{{ lab.name }} – Lab Allotments{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto bg-white p-6 rounded shadow">

  <!-- Header -->
  <header class="bg-pink-100 rounded-md shadow-sm p-4 text-center mb-6">
    <h1 class="text-xl sm:text-2xl font-semibold text-blue-700">
      Lab Allotments – {{ lab.name }}
    </h1>
  </header>

  <!-- Stats -->
  <div class="text-center mb-6">
    <h2 class="text-2xl font-bold text-blue-700 mb-1">
      Room: {{ lab.name }}
    </h2>
    <div class="text-sm text-yellow-900">
      <span><strong>Total Systems:</strong> {{ stats.total }}</span> |
      <span><strong>Allotted:</strong> {{ stats.used }}</span> |
      <span><strong>Available:</strong> {{ stats.available }}</span>
      {% if stats.staff_incharge %}
        | <span><strong>Staff In-charge:</strong> {{ stats.staff_incharge }}</span>
      {% endif %}
    </div>
  </div>

  <!-- 1️⃣ Cubicle Allotments -->
<div class="mb-10">
  <h3 class="text-lg font-semibold text-indigo-700 mb-3">Students Assigned Cubicles</h3>
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border border-gray-300 text-sm">
      <thead class="bg-indigo-100">
        <tr>
          <th class="py-2 px-4 border-b">#</th>
          <th class="py-2 px-4 border-b">Student Name</th>
          <th class="py-2 px-4 border-b">Roll</th>
          <th class="py-2 px-4 border-b">Course</th>
          <th class="py-2 px-4 border-b">Year</th>
          <th class="py-2 px-4 border-b">Faculty</th>
          <th class="py-2 px-4 border-b">Email</th>
          <th class="py-2 px-4 border-b">Phone</th>
          <th class="py-2 px-4 border-b">Cubicle No.</th>
          <th class="py-2 px-4 border-b">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for r in cubicle_records %}
        {% set has_machine = machine_records|selectattr("roll", "equalto", r.roll)|list %}
        <tr class="hover:bg-gray-50 {% if not has_machine %}bg-yellow-100 cursor-pointer{% endif %}"
            {% if not has_machine %}
              onclick="window.location.href='{{ url_for('assignment_new') }}?student_roll={{ r.roll }}&lab={{ lab.name }}'"
            {% endif %}>
          <td class="py-2 px-4 border-b">{{ loop.index }}</td>
          <td class="py-2 px-4 border-b">{{ r.name }}</td>
          <td class="py-2 px-4 border-b">{{ r.roll }}</td>
          <td class="py-2 px-4 border-b">{{ r.course }}</td>
          <td class="py-2 px-4 border-b">{{ r.year }}</td>
          <td class="py-2 px-4 border-b">{{ r.faculty }}</td>
          <td class="py-2 px-4 border-b">{{ r.email }}</td>
          <td class="py-2 px-4 border-b">{{ r.phone }}</td>
          <td class="py-2 px-4 border-b">{{ r.cubicle_number }}</td>
          <td class="py-2 px-4 border-b font-semibold">
            {% if has_machine %}
              ✅ Machine Assigned
            {% else %}
              ⚠ Machine Not Assigned (Click to Assign)
            {% endif %}
          </td>
  
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

  <!-- 2️⃣ Machine Allotments -->
  <div>
    <h3 class="text-lg font-semibold text-indigo-700 mb-3">Students Allotted Machines</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-300 text-sm">
        <thead class="bg-indigo-100">
          <tr>
            <th class="py-2 px-4 border-b">#</th>
            <th class="py-2 px-4 border-b">Student Name</th>
            <th class="py-2 px-4 border-b">Roll</th>
            <th class="py-2 px-4 border-b">Course</th>
            <th class="py-2 px-4 border-b">Year</th>
            <th class="py-2 px-4 border-b">Faculty</th>
            <th class="py-2 px-4 border-b">Email</th>
            <th class="py-2 px-4 border-b">Phone</th>
            <th class="py-2 px-4 border-b">Cubicle No.</th>
            <th class="py-2 px-4 border-b">System ID</th>
            <th class="py-2 px-4 border-b">Serial</th>
            <th class="py-2 px-4 border-b">Manufacturer</th>
            <th class="py-2 px-4 border-b">Model</th>
            <th class="py-2 px-4 border-b">Indenter</th>
            <th class="py-2 px-4 border-b">Issue Date</th>
            <th class="py-2 px-4 border-b">Required Till</th>
            <th class="py-2 px-4 border-b">Remarks</th>
          </tr>
        </thead>
        <tbody>
          {% for r in machine_records %}
          <tr class="hover:bg-gray-50">
            <td class="py-2 px-4 border-b">{{ loop.index }}</td>
            <td class="py-2 px-4 border-b">{{ r.name }}</td>
            <td class="py-2 px-4 border-b">{{ r.roll }}</td>
            <td class="py-2 px-4 border-b">{{ r.course }}</td>
            <td class="py-2 px-4 border-b">{{ r.year }}</td>
            <td class="py-2 px-4 border-b">{{ r.faculty }}</td>
            <td class="py-2 px-4 border-b">{{ r.email }}</td>
            <td class="py-2 px-4 border-b">{{ r.phone }}</td>
            <td class="py-2 px-4 border-b">{{ r.cubicle_number }}</td>
            <td class="py-2 px-4 border-b">{{ r.asset_id }}</td>
            <td class="py-2 px-4 border-b">{{ r.serial }}</td>
            <td class="py-2 px-4 border-b">{{ r.manufacturer }}</td>
            <td class="py-2 px-4 border-b">{{ r.model }}</td>
            <td class="py-2 px-4 border-b">{{ r.indenter }}</td>
            <td class="py-2 px-4 border-b">{{ r.issue_date }}</td>
            <td class="py-2 px-4 border-b">{{ r.system_required_till }}</td>
            <td class="py-2 px-4 border-b">{{ r.remarks or "-" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Back Button -->
  <div class="mt-6">
    <a href="{{ url_for('cse_labs') }}" 
       class="inline-block px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
      ⬅ Back to Labs
    </a>
  </div>

</div>
{% endblock %}
